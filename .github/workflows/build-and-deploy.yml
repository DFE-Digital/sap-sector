name: Build and Deploy
concurrency: build_and_deploy_${{ github.ref_name }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        type: choice
        default: review
        options:
          - review
          - test
          - production
      docker-image-tag:
        description: "Docker image tag to deploy (optional)"
        required: true
        type: string
      pull-request-number:
        description: "Pull request number (required for review environment)"
        required: false
        type: string
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, labeled]

env:
  TERRAFORM_BASE: terraform/application
  HEALTHCHECK_CMD: 'healthcheck'

jobs:
  build:
    name: Build
    if: ${{ github.event_name != 'workflow_dispatch' }}
    env:
      DOCKER_REPOSITORY: ghcr.io/dfe-digital/sap-sector
    outputs:
      docker-image-tag: ${{ steps.build-image.outputs.tag }}
    permissions:
      packages: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        name: Checkout

      - name: Build and push docker image
        id: build-image
        uses: DFE-Digital/github-actions/build-docker-image@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          context: .
          docker-repository: ${{ env.DOCKER_REPOSITORY }}
          max-cache: true
          reuse-cache: true
          snyk-token: ${{ secrets.SNYK_TOKEN }}

  test:
    name: Run Unit & Integration Tests with Coverage
    if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Debug --no-restore

      - name: Install Playwright
        working-directory: Tests/SAPSec.UI.Tests
        run: |
          dotnet tool install --global Microsoft.Playwright.CLI
          export PATH="$PATH:/root/.dotnet/tools"
          playwright install --with-deps chromium

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: build frontend assets
        working-directory: SAPSec.Web
        run: |
          npm ci
          npm run build-fe
          
          echo "=== Copy wwwroot in SAPSec.UI.Tests ==="
          mkdir -p ../Tests/SAPSec.UI.Tests/bin/Debug/net8.0/wwwroot
          cp -a ./wwwroot/. ../Tests/SAPSec.UI.Tests/bin/Debug/net8.0/wwwroot/ || true
          
          echo "=== Copy wwwroot in SAPSec.Integration.Tests ==="       
          mkdir -p ../Tests/SAPSec.Integration.Tests/bin/Debug/net8.0/wwwroot
          cp -a ./wwwroot/. ../Tests/SAPSec.Integration.Tests/bin/Debug/net8.0/wwwroot/ || true

      - name: Run All Tests with Coverage
        env:
          HEADED: 0
          PLAYWRIGHT_IGNORE_HTTPS_ERRORS: true
        run: |
          TEST_PROJECTS=$(find ./Tests -type f -name "*.Tests.csproj" | sort)
          
          for proj in $TEST_PROJECTS; do
            echo "=== Running tests in $proj ==="
          
            dotnet test "$proj" \
              --no-build \
              --configuration Debug \
              --results-directory "TestResults" \
              --logger "trx;LogFileName=$(basename "$proj" .csproj).trx" \
              /p:CollectCoverage=true \
              /p:CoverletOutputFormat=cobertura \
              /p:DeterministicReport=true \
              /p:UseSourceLink=true \
              /p:Exclude='[*]AspNetCoreGeneratedDocument.*%2c[*]AspNetCore.Views.*' \
              /p:ExcludeByAttribute='GeneratedCodeAttribute*%2cObsoleteAttribute*%2cExcludeFromCodeCoverage' \
              --verbosity normal
          done
      
      #Example of how to exclude tests from coverage https://github.com/coverlet-coverage/coverlet/blob/master/Documentation/MSBuildIntegration.md#filters

      - name: Upload Test Result Files
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: "**/TestResults/**/*"
          retention-days: 5

      - name: Publish Test Results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          reporter: 'dotnet-trx'
          path: "**/TestResults/**/*.trx"
          name: 'Test Results'

      - name: merge coverage files
        run: |
          dotnet tool install -g dotnet-coverage
          dotnet coverage merge --reports $(find Tests -name "coverage.cobertura.xml") -f cobertura -o coverage-results/coverage.xml

      - name: Generate Coverage Report
        uses: clearlyip/code-coverage-report-action@v6
        id: code_coverage_report_action
        if: ${{ github.actor != 'dependabot[bot]'}}
        with:
          filename: "coverage-results/coverage.xml"
          fail_on_negative_difference: true
          only_list_changed_files: true

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: steps.code_coverage_report_action.outputs.file != '' && github.event_name == 'pull_request' && (success() || failure())
        with:
          recreate: true
          path: code-coverage-results.md

  deploy-review-app:
    name: Deployment To Review
    concurrency:
      group: deploy_review_${{ github.event.pull_request.number || github.run_id }}
      cancel-in-progress: true
    if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy') }}
    needs: [build]
    environment:
      name: review
      url: ${{ steps.deploy_review.outputs.environment_url }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pull-requests: write
    env:
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
      KONDUIT_NAMESPACE: ${{ secrets.AKS_NAMESPACE }}
      KONDUIT_APP_NAME: ${{ secrets.KONDUIT_APP_NAME }}

    steps:
      - name: Deploy App to Review
        id: deploy_review
        uses: DFE-Digital/github-actions/deploy-to-aks@master
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          environment: review
          pr-number: ${{ github.event.pull_request.number }}
          sha: ${{ needs.build.outputs.docker-image-tag }}
          terraform-base: ${{ env.TERRAFORM_BASE }}
          healthcheck: ${{ env.HEALTHCHECK_CMD }}
          db-seed: false
          smoke-test: false

      # ---------------------------
      # REVIEW APP DATABASE SEED (PR)
      # ---------------------------
      - name: Checkout (needed for workspace consistency)
        uses: actions/checkout@v4

      - name: Install Azure CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install kubectl (pinned)
        shell: bash
        run: |
          set -euo pipefail
          KUBECTL_VERSION="v1.29.8"
          curl -fsSLo kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          sudo install -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client=true

      - name: Install kubelogin (pinned)
        shell: bash
        run: |
          set -euo pipefail
          KUBELOGIN_VERSION="v0.1.6"
          curl -fsSLo kubelogin.zip "https://github.com/Azure/kubelogin/releases/download/${KUBELOGIN_VERSION}/kubelogin-linux-amd64.zip"
          unzip -q kubelogin.zip
          sudo install -m 0755 bin/linux_amd64/kubelogin /usr/local/bin/kubelogin
          kubelogin --version

      - name: Configure AKS credentials
        shell: bash
        run: |
          set -euo pipefail
          : "${AKS_RESOURCE_GROUP:?AKS_RESOURCE_GROUP is not set}"
          : "${AKS_CLUSTER_NAME:?AKS_CLUSTER_NAME is not set}"
          az aks get-credentials --overwrite-existing -g "${AKS_RESOURCE_GROUP}" -n "${AKS_CLUSTER_NAME}"
          kubelogin convert-kubeconfig -l azurecli

      - name: Download konduit.sh
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/DFE-Digital/teacher-services-cloud/main/scripts/konduit.sh \
            -o "$GITHUB_WORKSPACE/konduit.sh"
          chmod +x "$GITHUB_WORKSPACE/konduit.sh"
          ls -la "$GITHUB_WORKSPACE/konduit.sh"

      - name: Download seed backup from Blob
        shell: bash
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          AZURE_STORAGE_CONTAINER: ${{ secrets.AZURE_STORAGE_CONTAINER }}
        run: |
          set -euo pipefail
          BACKUP_BLOB="db-backups/sappub_review_seed_latest.sql.gz"
          BACKUP_FILE="seed.sql.gz"

          az storage blob download \
            --container-name "${AZURE_STORAGE_CONTAINER}" \
            --name "${BACKUP_BLOB}" \
            --file "${BACKUP_FILE}" \
            --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
            --overwrite true

          ls -lh "${BACKUP_FILE}"

      - name: Read PR DB URL from review app secret
        id: prdb
        shell: bash
        run: |
          set -euo pipefail
          DEPLOY="get-school-improvement-insights-pr-${{ github.event.pull_request.number }}"
          SECRET_NAME=$(kubectl -n "${KONDUIT_NAMESPACE}" get deploy "$DEPLOY" -o jsonpath='{.spec.template.spec.containers[0].envFrom[1].secretRef.name}')
          if [ -z "$SECRET_NAME" ]; then
            echo "Secret name not found on deployment ${DEPLOY}"
            exit 1
          fi
          DB_URL_B64=$(kubectl -n "${KONDUIT_NAMESPACE}" get secret "$SECRET_NAME" -o jsonpath='{.data.DATABASE_URL}')
          if [ -z "$DB_URL_B64" ]; then
            echo "DATABASE_URL not found in secret ${SECRET_NAME}"
            exit 1
          fi
          DB_URL=$(echo "$DB_URL_B64" | base64 -d)
          echo "db_url=$DB_URL" >> "$GITHUB_OUTPUT"

      - name: Restore backup into PR review DB
        shell: bash
        run: |
          set -euo pipefail
          BACKUP_FILE="seed.sql.gz"
          ls -lh "${BACKUP_FILE}"
          gzip -t "${BACKUP_FILE}"

          "$GITHUB_WORKSPACE/konduit.sh" \
            -n "${KONDUIT_NAMESPACE}" \
            -u "${{ steps.prdb.outputs.db_url }}" \
            -t 7200 \
            -x \
            -i "${BACKUP_FILE}" -c \
            "${KONDUIT_APP_NAME}" -- psql -v ON_ERROR_STOP=1 -X

  deploy:
    name: Deploy environments
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy_app.outputs.environment_url }}
    needs: [build, test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pull-requests: write
    strategy:
      max-parallel: 1
      matrix:
        environment: [test, production]

    steps:
      - name: Deploy app to ${{ matrix.environment }}
        id: deploy_app
        uses: DFE-Digital/github-actions/deploy-to-aks@master
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          environment: ${{ matrix.environment }}
          sha: ${{ needs.build.outputs.docker-image-tag }}
          terraform-base: ${{ env.TERRAFORM_BASE }}
          healthcheck: ${{ env.HEALTHCHECK_CMD }}
          slack-webhook: ${{ secrets.SLACK_WEBHOOK }}
          smoke-test: false

  manual_deploy:
    name: Manual deploy
    concurrency:
      group: deploy_manual_${{ inputs.environment }}_${{ inputs.pull-request-number || github.run_id }}
      cancel-in-progress: true
    if: ${{ github.event_name == 'workflow_dispatch' }}
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy_manual.outputs.environment_url }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pull-requests: write

    steps:
      - name: Deploy app to ${{ inputs.environment }}
        id: deploy_manual
        uses: DFE-Digital/github-actions/deploy-to-aks@master
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          environment: ${{ inputs.environment }}
          pr-number: ${{ inputs.pull-request-number }}
          sha: ${{ inputs.docker-image-tag }}
          terraform-base: ${{ env.TERRAFORM_BASE }}
          healthcheck: ${{ env.HEALTHCHECK_CMD }}
          slack-webhook: ${{ secrets.SLACK_WEBHOOK }}
          smoke-test: false
